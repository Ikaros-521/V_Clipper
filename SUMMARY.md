# è§†é¢‘åˆ‡åˆ†æœåŠ¡å®Œå–„æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒåŠŸèƒ½å¢å¼º

#### ğŸ¯ çµæ´»çš„è¿”å›æ–¹å¼
- âœ… **è¿”å›æ–‡ä»¶æ¨¡å¼** (`return_type=file`): ç›´æ¥è¿”å›è§†é¢‘æ–‡ä»¶ï¼Œé€‚åˆä¸‹è½½
- âœ… **è¿”å›URLæ¨¡å¼** (`return_type=url`): è¿”å›è®¿é—®é“¾æ¥ï¼Œé€‚åˆVLMåˆ†æå’Œè¿œç¨‹è®¿é—®
- âœ… é€šè¿‡ `/media/` è·¯å¾„æä¾›é™æ€æ–‡ä»¶è®¿é—®

#### â±ï¸ çµæ´»çš„æ—¶é—´æŒ‡å®šæ–¹å¼
- âœ… **æŒç»­æ—¶é—´æ¨¡å¼** (`start` + `duration`): æŒ‡å®šèµ·å§‹æ—¶é—´å’ŒæŒç»­æ—¶é•¿
- âœ… **èµ·æ­¢æ—¶é—´æ¨¡å¼** (`start` + `end`): æŒ‡å®šèµ·å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´
- âœ… è‡ªåŠ¨å‚æ•°éªŒè¯å’Œé”™è¯¯æç¤º
- âœ… ä¸¤ç§æ–¹å¼å¯æ ¹æ®ä½¿ç”¨åœºæ™¯çµæ´»é€‰æ‹©

#### ğŸ§¹ è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- âœ… **å®šæ—¶è‡ªåŠ¨æ¸…ç†**: æ¯1å°æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡æ¸…ç†ä»»åŠ¡
- âœ… **å¯é…ç½®è¿‡æœŸæ—¶é—´**: é»˜è®¤æ¸…ç†2å°æ—¶å‰çš„æ–‡ä»¶
- âœ… **æ¸…ç†èŒƒå›´**: åŒ…æ‹¬ä¸Šä¼ çš„åŸå§‹è§†é¢‘å’Œç”Ÿæˆçš„åˆ‡ç‰‡æ–‡ä»¶
- âœ… **åå°ä»»åŠ¡**: ä½¿ç”¨ asyncio åœ¨åå°è¿è¡Œï¼Œä¸å½±å“ä¸»æœåŠ¡
- âœ… **å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨**: æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹å®šæœŸæ¸…ç†

#### ğŸ› ï¸ æ‰‹åŠ¨æ¸…ç†æ¥å£
- âœ… **DELETE /cleanup**: æ‰‹åŠ¨è§¦å‘æ¸…ç†ä»»åŠ¡
- âœ… **å¯é…ç½®æ¸…ç†æ—¶é—´**: é€šè¿‡å‚æ•°æŒ‡å®šæ¸…ç†å¤šå°‘å°æ—¶å‰çš„æ–‡ä»¶
- âœ… **è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯**: è¿”å›åˆ é™¤æ–‡ä»¶æ•°å’Œé‡Šæ”¾ç©ºé—´å¤§å°

### 2. æ–°å¢æ¥å£

#### ğŸ“Š GET /stats - å­˜å‚¨ç»Ÿè®¡
```json
{
  "uploads": {
    "count": 5,
    "size_mb": 150.25
  },
  "segments": {
    "count": 23,
    "size_mb": 89.67
  },
  "total_size_mb": 239.92,
  "cleanup_config": {
    "interval_hours": 1,
    "expiry_hours": 2
  }
}
```

#### ğŸ—‘ï¸ DELETE /cleanup - æ‰‹åŠ¨æ¸…ç†
```json
{
  "success": true,
  "deleted_count": 15,
  "freed_space_mb": 234.56,
  "hours": 2
}
```

### 3. é…ç½®ç®¡ç†

#### ğŸ“ config.py - é›†ä¸­é…ç½®
```python
# æœåŠ¡é…ç½®
HOST = "0.0.0.0"
PORT = 8700

# æ¸…ç†é…ç½®
CLEANUP_INTERVAL_HOURS = 1  # æ¸…ç†é—´éš”
FILE_EXPIRY_HOURS = 2       # æ–‡ä»¶è¿‡æœŸæ—¶é—´

# FFmpeg é»˜è®¤å‚æ•°
DEFAULT_SCALE = "480:-1"
DEFAULT_FPS = 10
DEFAULT_CRF = 28
DEFAULT_PRESET = "ultrafast"
```

### 4. æ—¥å¿—ç³»ç»Ÿ

- âœ… ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- âœ… è®°å½•æ‰€æœ‰å…³é”®æ“ä½œï¼ˆä¸Šä¼ ã€åˆ‡ç‰‡ã€æ¸…ç†ï¼‰
- âœ… é”™è¯¯è¿½è¸ªå’Œè°ƒè¯•ä¿¡æ¯
- âœ… å¯é…ç½®æ—¥å¿—çº§åˆ«

### 5. é”™è¯¯å¤„ç†

- âœ… FFmpeg æœªå®‰è£…æ£€æµ‹
- âœ… æ–‡ä»¶ä¸å­˜åœ¨å¤„ç†
- âœ… åˆ‡ç‰‡å¤±è´¥è¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… æ¸…ç†ä»»åŠ¡å¼‚å¸¸æ•è·

### 6. æ–‡æ¡£å’Œå·¥å…·

#### ğŸ“š å®Œæ•´æ–‡æ¡£
- âœ… **README.md**: å®Œæ•´çš„é¡¹ç›®æ–‡æ¡£å’ŒAPIè¯´æ˜
- âœ… **EXAMPLES.md**: è¯¦ç»†çš„ä½¿ç”¨ç¤ºä¾‹ï¼ˆPythonã€cURLã€JavaScriptï¼‰
- âœ… **TIME_MODES.md**: ä¸¤ç§æ—¶é—´æŒ‡å®šæ–¹å¼çš„è¯¦ç»†è¯´æ˜å’Œå¯¹æ¯”
- âœ… **SUMMARY.md**: å®Œå–„æ€»ç»“æ–‡æ¡£
- âœ… **config.py**: é…ç½®æ–‡ä»¶è¯´æ˜

#### ğŸ§ª æµ‹è¯•å·¥å…·
- âœ… **test_api.py**: äº¤äº’å¼æµ‹è¯•è„šæœ¬
- âœ… æ”¯æŒæ‰€æœ‰æ¥å£çš„æµ‹è¯•
- âœ… å‹å¥½çš„å‘½ä»¤è¡Œäº¤äº’

#### ğŸš€ å¯åŠ¨è„šæœ¬
- âœ… **start.bat**: Windows å¯åŠ¨è„šæœ¬
- âœ… **start.sh**: Linux/Mac å¯åŠ¨è„šæœ¬
- âœ… è‡ªåŠ¨æ£€æŸ¥ä¾èµ–å’Œç¯å¢ƒ

#### ğŸ“¦ ä¾èµ–ç®¡ç†
- âœ… **requirements.txt**: Python ä¾èµ–åˆ—è¡¨
- âœ… **.gitignore**: Git å¿½ç•¥é…ç½®

---

## ğŸ¨ æ”¹è¿›äº®ç‚¹

### 1. æ¶æ„ä¼˜åŒ–
- é…ç½®ä¸ä»£ç åˆ†ç¦»
- æ¨¡å—åŒ–è®¾è®¡
- å¼‚æ­¥ä»»åŠ¡å¤„ç†

### 2. ç”¨æˆ·ä½“éªŒ
- çµæ´»çš„è¿”å›æ–¹å¼ï¼ˆæ–‡ä»¶/URLï¼‰
- è¯¦ç»†çš„é”™è¯¯æç¤º
- å®Œæ•´çš„APIæ–‡æ¡£ï¼ˆSwagger UIï¼‰

### 3. è¿ç»´å‹å¥½
- è‡ªåŠ¨æ¸…ç†èŠ‚çœå­˜å‚¨
- å®æ—¶ç»Ÿè®¡ç›‘æ§
- æ‰‹åŠ¨æ¸…ç†æ§åˆ¶
- ç»“æ„åŒ–æ—¥å¿—

### 4. å¼€å‘å‹å¥½
- å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
- å¤šè¯­è¨€å®¢æˆ·ç«¯ç¤ºä¾‹
- äº¤äº’å¼æµ‹è¯•å·¥å…·
- ä¸€é”®å¯åŠ¨è„šæœ¬

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
V_Clipper/
â”œâ”€â”€ app.py                  # ä¸»åº”ç”¨ï¼ˆå®Œå–„åï¼‰
â”œâ”€â”€ config.py               # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt        # Pythonä¾èµ–
â”œâ”€â”€ README.md               # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ EXAMPLES.md             # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ TIME_MODES.md           # æ—¶é—´å‚æ•°è¯´æ˜
â”œâ”€â”€ SUMMARY.md              # å®Œå–„æ€»ç»“
â”œâ”€â”€ test_api.py             # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ start.bat               # Windowså¯åŠ¨è„šæœ¬
â”œâ”€â”€ start.sh                # Linux/Macå¯åŠ¨è„šæœ¬
â”œâ”€â”€ .gitignore              # Gitå¿½ç•¥é…ç½®
â””â”€â”€ media_data/             # æ•°æ®ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
    â”œâ”€â”€ uploads/            # ä¸Šä¼ çš„åŸå§‹è§†é¢‘
    â””â”€â”€ segments/           # ç”Ÿæˆçš„åˆ‡ç‰‡æ–‡ä»¶
```

---

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›å¯¹æ¯”

### åŸç‰ˆ app.py
```python
# âŒ åªèƒ½è¿”å›æ–‡ä»¶
return FileResponse(output_path)

# âŒ æ¸…ç†åŠŸèƒ½æœªå®ç°
@app.delete("/cleanup")
async def cleanup():
    pass

# âŒ æ— é…ç½®ç®¡ç†
# âŒ æ— æ—¥å¿—ç³»ç»Ÿ
# âŒ æ— ç»Ÿè®¡åŠŸèƒ½
```

### å®Œå–„å app.py
```python
# âœ… æ”¯æŒè¿”å›æ–‡ä»¶æˆ–URL
if return_type == "url":
    return JSONResponse({"url": file_url, ...})
else:
    return FileResponse(output_path, ...)

# âœ… å®Œæ•´çš„æ¸…ç†å®ç°
def cleanup_old_files(hours):
    # æ¸…ç†é€»è¾‘
    return deleted_count, total_size

# âœ… å®šæ—¶è‡ªåŠ¨æ¸…ç†
async def periodic_cleanup():
    while True:
        cleanup_old_files()
        await asyncio.sleep(CLEANUP_INTERVAL_HOURS * 3600)

# âœ… å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
@app.on_event("startup")
async def startup_event():
    asyncio.create_task(periodic_cleanup())

# âœ… é…ç½®ç®¡ç†
from config import *

# âœ… æ—¥å¿—ç³»ç»Ÿ
logger.info("æ“ä½œæ—¥å¿—")

# âœ… ç»Ÿè®¡åŠŸèƒ½
@app.get("/stats")
async def get_stats():
    return {...}
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 2. å¯åŠ¨æœåŠ¡
```bash
# Windows
start.bat

# Linux/Mac
chmod +x start.sh && ./start.sh

# æˆ–ç›´æ¥è¿è¡Œ
python app.py
```

### 3. è®¿é—®æ–‡æ¡£
- Swagger UI: http://localhost:8700/docs
- ReDoc: http://localhost:8700/redoc
- ç»Ÿè®¡ä¿¡æ¯: http://localhost:8700/stats

### 4. æµ‹è¯•æœåŠ¡
```bash
python test_api.py
```

---

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: VLMè§†é¢‘åˆ†æ
```python
import requests

# æ–¹å¼1ï¼šä½¿ç”¨æŒç»­æ—¶é—´ï¼ˆå›ºå®šæ—¶é•¿é‡‡æ ·ï¼‰
response = requests.get(f"{BASE_URL}/clip", params={
    "file_id": file_id,
    "start": 10,
    "duration": 5,
    "return_type": "url"  # è¿”å›URL
})
video_url = response.json()["url"]

# æ–¹å¼2ï¼šä½¿ç”¨èµ·æ­¢æ—¶é—´ï¼ˆç²¾ç¡®æ—¶é—´åŒºé—´ï¼‰
response = requests.get(f"{BASE_URL}/clip", params={
    "file_id": file_id,
    "start": 10,
    "end": 15,
    "return_type": "url"  # è¿”å›URL
})
video_url = response.json()["url"]

# ä¼ ç»™VLMåˆ†æ
# vlm_result = analyze_video_with_vlm(video_url)
```

### åœºæ™¯2: æ‰¹é‡ä¸‹è½½åˆ‡ç‰‡
```python
# ç›´æ¥ä¸‹è½½æ–‡ä»¶
response = requests.get(f"{BASE_URL}/clip", params={
    "file_id": file_id,
    "start": 10,
    "duration": 5,
    "return_type": "file"  # è¿”å›æ–‡ä»¶
})
with open("clip.mp4", "wb") as f:
    f.write(response.content)
```

### åœºæ™¯3: å­˜å‚¨ç®¡ç†
```python
# æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ
stats = requests.get(f"{BASE_URL}/stats").json()
print(f"æ€»å¤§å°: {stats['total_size_mb']} MB")

# æ‰‹åŠ¨æ¸…ç†æ—§æ–‡ä»¶
result = requests.delete(f"{BASE_URL}/cleanup?hours=3").json()
print(f"é‡Šæ”¾ç©ºé—´: {result['freed_space_mb']} MB")
```

---

## ğŸ¯ å…³é”®ç‰¹æ€§

1. âœ… **çµæ´»è¿”å›**: æ”¯æŒæ–‡ä»¶å’ŒURLä¸¤ç§è¿”å›æ–¹å¼
2. âœ… **çµæ´»æ—¶é—´**: æ”¯æŒæŒç»­æ—¶é—´å’Œèµ·æ­¢æ—¶é—´ä¸¤ç§æŒ‡å®šæ–¹å¼
3. âœ… **è‡ªåŠ¨æ¸…ç†**: å®šæ—¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶
4. âœ… **æ‰‹åŠ¨æ§åˆ¶**: æ”¯æŒæ‰‹åŠ¨è§¦å‘æ¸…ç†ä»»åŠ¡
5. âœ… **å®æ—¶ç›‘æ§**: æä¾›å­˜å‚¨ç»Ÿè®¡æ¥å£
6. âœ… **é…ç½®çµæ´»**: é›†ä¸­é…ç½®ç®¡ç†
7. âœ… **æ—¥å¿—å®Œå–„**: ç»“æ„åŒ–æ—¥å¿—è®°å½•
8. âœ… **æ–‡æ¡£é½å…¨**: å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹
9. âœ… **æ˜“äºéƒ¨ç½²**: ä¸€é”®å¯åŠ¨è„šæœ¬

---

## ğŸ“ é…ç½®è¯´æ˜

### ä¿®æ”¹æ¸…ç†æ—¶é—´
ç¼–è¾‘ `config.py`:
```python
CLEANUP_INTERVAL_HOURS = 2  # æ”¹ä¸ºæ¯2å°æ—¶æ¸…ç†ä¸€æ¬¡
FILE_EXPIRY_HOURS = 4       # æ”¹ä¸ºæ¸…ç†4å°æ—¶å‰çš„æ–‡ä»¶
```

### ä¿®æ”¹é»˜è®¤è§†é¢‘å‚æ•°
ç¼–è¾‘ `config.py`:
```python
DEFAULT_SCALE = "720:-1"    # æ”¹ä¸º720p
DEFAULT_FPS = 15            # æ”¹ä¸º15å¸§/ç§’
DEFAULT_CRF = 25            # æ”¹ä¸ºæ›´é«˜è´¨é‡
```

### ä¿ç•™åŸå§‹è§†é¢‘ä¸è¢«æ¸…ç†
ç¼–è¾‘ `app.py` çš„ `cleanup_old_files` å‡½æ•°ï¼Œæ³¨é‡Šæ‰æ¸…ç†ä¸Šä¼ æ–‡ä»¶çš„éƒ¨åˆ†ã€‚

---

## ğŸ‰ æ€»ç»“

è¿™ä¸ªå®Œå–„åçš„è§†é¢‘åˆ‡åˆ†æœåŠ¡ç°åœ¨å…·å¤‡äº†ï¼š
- âœ… ç”Ÿäº§çº§åˆ«çš„åŠŸèƒ½å®Œæ•´æ€§
- âœ… çµæ´»çš„ä½¿ç”¨æ–¹å¼
- âœ… è‡ªåŠ¨åŒ–çš„è¿ç»´ç®¡ç†
- âœ… å®Œå–„çš„æ–‡æ¡£å’Œå·¥å…·
- âœ… è‰¯å¥½çš„å¯ç»´æŠ¤æ€§

å¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒï¼

